<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="./css/style.css">
  
  <title>chat</title>
</head>
<body>
  <h1>DIVER'S LOG</h1>
  <h2>ユーザー:<span id="login_user"></span></h2>

  <div id="form_section">

    <form>
      <fieldset>
        <legend>新規登録画面</legend>
        <div>email: <input type="email" id="new_email" /></div>
        <div>password: <input type="password" id="new_password" /></div>
        <div>
          <button type="button" id="signin_btn">signin</button>
        </div>
      </fieldset>
    </form>

    <form>
      <fieldset>
        <legend>ログイン画面</legend>
        <div>email: <input type="email" id="login_email" /></div>
        <div>password: <input type="password" id="login_password" /></div>
        <div>
          <button type="button" id="login_btn">login</button>
          <button type="button" id="logout_btn">logout</button>
        </div>
      </fieldset>
    </form>

    <div>
      <fieldset>
        <legend>ユーザー情報登録</legend>
        <div>name: <input type="text" id="user_name" /></div>
        <div>image: <input type="file" id="user_img" accept=".png, .jpeg, .jpg" required/></div>
        <button id ="upload">upload</button>
        <img src="https://via.placeholder.com/150" id="sel_img">
        <div>
          <button type="button" id="set_btn">set</button>
          
        </div>
      </fieldset>
    </div>

    <form>
      <fieldset>
        <legend>チャット入力画面</legend>
        <div>name: <input type="text" id="name" /></div>
        <div>text: <input type="text" id="text" /></div>
        <div>
          <button type="button" id="send">send</button>
        </div>
      </fieldset>
    </form>

  </div>

  <div id="canvas_section">
    色選択<input type="color" id="color">
    ペンの太さ<input type="range" id="line" min="1" max="50" value="5" step="1">
    <button id="clear_btn">クリア</button>
    <button id="image_send">送信</button><br>
    <canvas id="canvas" width="600" height="400" style="border:1px solid #000;"></canvas>
  </div>
  
  <!-- データ出力場所 -->
  <ul id="output"></ul>


  <!-- jquery読み込み -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

  <script>
    // 日時をいい感じの形式にする関数(Timestamp);
    function convertFromFirestoreTimestampToDatetime(timestamp) {
      const _d = timestamp ? new Date(timestamp * 1000) : new Date();
      const Y = _d.getFullYear();
      const m = (_d.getMonth() + 1).toString().padStart(2, '0');
      const d = _d.getDate().toString().padStart(2, '0');
      const H = _d.getHours().toString().padStart(2, '0');
      const i = _d.getMinutes().toString().padStart(2, '0');
      const s = _d.getSeconds().toString().padStart(2, '0');
      return `${Y}/${m}/${d} ${H}:${i}:${s}`;
    }
    
  </script>
  <!-- firebaseのいろいろ読み込み -->
  <script type ="module">//バージョンを合わせる！
  
  //Firebaceを利用するためのコード
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-app.js";
  
  //firebase-authを利用するためのコード
  import {  
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        updateProfile,
      
    } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-auth.js";
  
  //Firebaceの関数を利用するためのコード
  import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      onSnapshot,
      query,
      orderBy,
      deleteDoc,
      doc,
      
    } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-firestore.js";

  //storegeを使うためのコード  
  import { 
      getStorage,
      ref,
      uploadBytes,
    } from "https://www.gstatic.com/firebasejs/9.2.0/firebase-storage.js";


//自分のプロダクトを特定するためのコード
    const firebaseConfig = {
      
    };
    
    //Firebaceを利用するためのコード
    const app = initializeApp(firebaseConfig);    
    //datebaceを利用するためのコード
    const db = getFirestore(app);
    //authenticationを利用するためのコード
    const auth = getAuth(app);
    //ログインしているユーザー確認
    const user = auth.currentUser;

    const storage = getStorage(app);
    //const storage2 = getStorage(customApp, "gs://my-custom-bucket");


    //データを持ってくるときに時間の降順に並び替えるためのコード
    const q = query(collection(db, "chat"), orderBy("time", "desc"));

//-------------ユーザーのログイン状態を確認する-------------------------------/////
    //ログインしていないときはuserにnullを返す
    if (user) {
      //       
      } else {
        // No user is signed in.
        //ログインしていないときはuserにnullを返す
        console.log(user);
        $('#login_user').text('null');
      }


//------------ユーザー新規登録-----------------------------------------------//////

    $('#signin_btn').on('click',function(){ //signinボタンを押したら発動
      const email = $('#new_email').val(); //new_emailの入力値を変数emailへ代入
      const password = $('#new_password').val(); //new_passwordの入力値を変数passwordへ代入

      createUserWithEmailAndPassword(auth, email, password)//ユーザ登録を実行
          .then((userCredential) => { //成功したら
            // Signed in
            const user = userCredential.user;
            console.log('created'); //コンソールにcreated
            alert('登録完了しました');//アラートを出す
            $('#new_email').val();//new_emailの入力欄を空に
            $('#new_password').val(); //new_passwordの入力欄を空に

            
            // ...
          })
          .catch((error) => { //失敗したら
            const errorCode = error.code;
            const errorMessage = error.message;
            console.log(error.code + error.message);//コンソールにエラーを出す
            // ..
          });
    });//signinボタンを押したら発動ここまで

    //---------------------作成中---------------------------------------------//

    //ユーザー情報登録

    // $('#set_btn').on('click', function () {
    //     console.log('click');
    //     const name = $('#user_name').val();
    //     const img = $('#user_img').val();

    //     console.log(name);
    //     console.log(img);
    //     updateProfile(auth.currentUser, {
    //       displayName: name, photoURL: img
    //     }).then(() => {
    //       // Profile updated!
    //       // ...
    //       console.log('sucsees');
    //     }).catch((error) => {
    //       // An error occurred
    //       // 
    //       console.log(error);
    //     });


//})

//アップロードのボタンイベント
$('#upload').on('click',function(){
  const file = $('#user_img')[0].files[0];
  if (!file) {
    alert('ファイルが設定されていません');
  }
  
  const user_pic = ref(storage, 'user/users.jpg');
  uploadBytes(user_pic, file).then((snapshot) => {
    console.log('Uploaded a blob or file!');
  });


});

//---------ログイン-------------------------------------------------------------////

    $('#login_btn').on('click',function(){ //logininボタンを押したら発動
      const email = $('#login_email').val(); //login_emailの入力値を変数emailへ代入
      const password = $('#login_password').val(); //login_passwordの入力値を変数passwordへ代入

      signInWithEmailAndPassword(auth, email, password) //ログイン処理を実行
          .then((userCredential) => { //成功したら
            // Signed in
            const user = userCredential.user;
            console.log('login'); //コンソールにlogin！
            alert('ログインしました');//アラートを出す
            $('#login_email').val();//login_emailの入力欄を空に
            $('#login_password').val();//login_passwordの入力欄を空に

            onAuthStateChanged(auth, (user) => {
              if (user) {
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/firebase.User
                const uid = user.uid;
                console.log(uid);
                $('#login_user').text(uid);
                // ...
              } else {
                // User is signed out
                // ...
              }
            });//onAuthStateChangedここまで

            })

            // ...
          
          .catch((error) => { //失敗したら
            const errorCode = error.code;
            const errorMessage = error.message;
            console.log(error.code + error.message);//コンソールにエラーを出す  
          })

          });//logininボタンを押したら発動ここまで

//----------ログアウト----------------------------------------------------------//
    $('#logout_btn').on('click', function () { //logoutボタンが押されたら
      signOut(auth).then(() => {
          // Sign-out successful.
          console.log('logout');
          alert("ログアウトしました");
          //ユーザのログイン状態を確認
          //ログインしていないときはuserにnullを返す
            if (user) {
              //       
              } else {
                // No user is signed in.
                //ログインしていないときはuserにnullを返す
                console.log(user);
                $('#login_user').text('null');
            }

        }).catch((error) => { //失敗したら
          // An error happened.
          console.log(error); //コンソールにエラーを出す
        });        
    }); //logoutボタンが押されたらここまで




    //入力されたテキストデータを送信する関数
    function sendChatTextDate() {
        const data = {//データ送信用の変数
          name: $("#name").val(),//name欄に入力されたもの
          text: $("#text").val(),//text欄に入力されたもの
          img:"",
          time: serverTimestamp(),//現在時間
        };
        addDoc(collection(db, "chat"), data);//Firebaseのchatコレクションにデータを送る
        $("#text").val("");//text欄は空欄に
      }
  //sendボタンが押されたら
    $('#send').on('click', function () { //sendボタンが押されたら発動
      //console.log('click');//コンソールにクリックと表示
      sendChatTextDate();//テキストデータを送信する関数を実行
    });

  //キーが押されたら
    $("#text").on("keydown", function (e) { //キーが押されたら発動
      if (e.keyCode === 13) { //エンターキーだった場合は、
        sendChatTextDate(); //テキストデータを送信する関数を実行
      }
    });

    //チャットデータ読み込み
    onSnapshot(q, (querySnapshot) => {
      //データの変更が発生したタイミングで発動(読み込んだときも発動)
      //console.log(querySnapshot.docs);//取ってきたデータをコンソールに出す（情報たくさん）

      const dataArray = [];//必要なデータだけを入れるための配列を準備
      //docs（情報たくさん）に対して繰り返し処理
      querySnapshot.docs.forEach(function (doc) {
      //docに入れて必要なデータを取る
        const data = {
          id: doc.id,//idを取る（自動生成されるやつ）
          data: doc.data(),//dataを取る（ボタンを押してサーバーに保存したやつ）
        };

        dataArray.push(data); //オブジェクトにして配列にいれる
      });

      //必要なものだけ入れたオブジェクトができた！(dateArray)
      console.log(dataArray);//コンソールに出す
      //表示するためにhtmlコードにしよう！
      const tagArray = [];//htmlタグをつけるための配列を準備

      //dataをいれた配列に対して繰り返し処理
      dataArray.forEach(function (data) {
      //dateArrayに入れてタグを付けたものをtagArrayに入れる！
      //console.log(convertFromFirestoreTimestampToDatetime(data.data.time.seconds));
      tagArray.push(`
        <li id="${data.id}">
          <p>${data.data.name} at ${convertFromFirestoreTimestampToDatetime(data.data.time.seconds)}</p>
          <p>${data.data.text}</p>
          <img src =${data.data.img}>         
          <button class="close">削除</button>
        </li>
      `);
        });//dataArray.forEachここまで

      //タグを付けたものをhtml化する！
      $("#output").html(tagArray);
    });//onSnapshotここまで

    
    

    //canvasについての記述

    let canvas_mouse_event = false; //スイッチ[ true=線を引く、false=線は引かない]
      let oldX = 0; //一つ前の座標を代入するための変数
      let oldY = 0; //一つ前の座標を代入するための変数
      let bold_line = 5; //ラインの太さをここで指定
      let color = "#000"; //ラインの太さをここで指定

      const can = $('#canvas')[0]; //キャンバスそのものを変数
      const ctx = can.getContext("2d"); //canに対してgetContext関数を実行し書き込み権限を与える

      $(can).on("mousedown", function (e) {
        console.log('on');
          oldX = e.offsetX; 
          oldY = e.offsetY;
          canvas_mouse_event = true;
        });
    

        $(can).on("mousemove", function (e) {
          
        if (canvas_mouse_event === true) {

              const px = e.offsetX;//時点の座標
              const py = e.offsetY; //時点の座標
              ctx.strokeStyle = color; //色
              ctx.lineWidth = bold_line; //大きさ
              ctx.lineJoin = "round";
              ctx.lineCap = "round";//ペン先を丸く
              ctx.beginPath();//パスの開始
              ctx.moveTo(oldX, oldY);
              ctx.lineTo(px, py);
              ctx.stroke();//出発地点から現時点の線を描写
              oldX = px; //出発地点の入れ替え
              oldY = py; //出発地点の入れ替え
            }
          });

          $(can).on("mouseup", function (e) {
            canvas_mouse_event = false;//ボタンを上げたら
          });

          $(can).mouseleave(function () {
              canvas_mouse_event = false;
          });

          $('#clear_btn').on("click", function () {
            ctx.closePath();
            ctx.clearRect(0, 0, can.width, can.height);//canvasをクリア
          })


          //パスの開始
          ctx.beginPath();

          //色変更
          $('#color').on('change', function () {
              let sel_color = $('#color').val();
              console.log(sel_color);
              color = sel_color;
            })

          //ラインを変更
          $('#line').on('change', function () {
              let line = $('#line').val();
              console.log(line);
              console.log('change');
              bold_line = line;
            })

            //画像を送信
            $('#image_send').on('click',function(){
              console.log('click');
              const img_data = canvas.toDataURL("image/jpg");
              
              const data = {//データ送信用の変数
                name:"",
                text:"",
                img: img_data,//name欄に入力されたもの                
                time: serverTimestamp(),//現在時間
              };
              addDoc(collection(db, "chat"), data);//Firebaseのchatコレクションにデータを送る
              ctx.closePath();
              ctx.clearRect(0, 0, can.width, can.height);
            });
    
  </script>  
</body>
</html>